rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // ğŸ” ë³µìƒ˜ìš”ê°€ Firestore ë³´ì•ˆ ê·œì¹™
    // 2026-02-07 ì„¸ë¶„í™”ëœ ì»¬ë ‰ì…˜ë³„ ê·œì¹™ ì ìš©
    // ========================================
    
    // Helper: Check if user has admin claim
    function isAdmin() {
      return request.auth != null && 
             request.auth.token.admin == true;
    }
    
    // Helper: Check if user is instructor or higher  
    function isStaff() {
      return request.auth != null && 
             (request.auth.token.admin == true || 
              request.auth.token.instructor == true);
    }
    
    // Helper: Check if authenticated
    function isAuth() {
      return request.auth != null;
    }
    
    // ========================================
    // ğŸ“‹ Members - íšŒì› ì •ë³´
    // ========================================
    match /members/{memberId} {
      allow read: if isStaff();
      allow write: if isAdmin();
    }
    
    // ========================================
    // âœ… Attendance - ì¶œì„ ê¸°ë¡
    // Kiosk (Anonymous) can create, Staff can read
    // ========================================
    match /attendance/{attendanceId} {
      allow read: if isStaff();
      allow create: if isAuth();
      allow update, delete: if isAdmin();
    }
    
    // ========================================
    // ğŸ“¢ Notices - ê³µì§€ì‚¬í•­
    // Public read, Admin write
    // ========================================
    match /notices/{noticeId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }
    
    // ========================================
    // ğŸ’¬ Messages - ê°œì¸ ë©”ì‹œì§€
    // Member reads own, Admin writes
    // ========================================
    match /messages/{messageId} {
      allow read: if isAuth() && 
                    (isAdmin() || resource.data.memberId == request.auth.uid);
      allow write: if isAdmin();
    }
    
    // ========================================
    // ğŸ–¼ï¸ Images - ê°¤ëŸ¬ë¦¬ ì´ë¯¸ì§€
    // Public read, Admin write
    // ========================================
    match /images/{imageId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }
    
    // ========================================
    // ğŸ”” FCM Tokens - í‘¸ì‹œ í† í°
    // Anyone can register, Admin can read/delete
    // ========================================
    match /fcm_tokens/{tokenId} {
      allow read: if isAdmin();
      allow create, update: if isAuth();
      allow delete: if isAdmin();
    }
    
    match /fcmTokens/{tokenId} {
      allow read: if isAdmin();
      allow create, update: if isAuth();
      allow delete: if isAdmin();
    }
    
    match /push_tokens/{tokenId} {
      allow read: if isAdmin();
      allow create, update: if isAuth();
      allow delete: if isAdmin();
    }
    
    // ========================================
    // ğŸ’° Sales - ë§¤ì¶œ ê¸°ë¡
    // Admin only
    // ========================================
    match /sales/{saleId} {
      allow read, write: if isAdmin();
    }
    
    // ========================================
    // ğŸ“… Daily Classes - ì¼ì¼ ìˆ˜ì—…
    // Staff read, Admin write
    // ========================================
    match /daily_classes/{classId} {
      allow read: if isStaff();
      allow write: if isAdmin();
    }
    
    // ========================================
    // ğŸ¤– AI Error Logs - AI ì—ëŸ¬ ë¡œê·¸
    // Admin read, Cloud Functions write only
    // ========================================
    match /ai_error_logs/{logId} {
      allow read: if isAdmin();
      allow write: if false; // Only Cloud Functions with Admin SDK
    }
    
    // ========================================
    // ğŸ“£ Push Campaigns - í‘¸ì‹œ ìº í˜ì¸
    // Admin only
    // ========================================
    match /push_campaigns/{campaignId} {
      allow read, write: if isAdmin();
    }
    
    // ========================================
    // âš™ï¸ App Config - ì•± ì„¤ì •
    // Public read, Admin write
    // ========================================
    match /config/{configId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }
    
    // ========================================
    // ğŸ“Š AI Usage Logs - AI ì‚¬ìš©ëŸ‰
    // Staff read, System write
    // ========================================
    match /ai_usage/{usageId} {
      allow read: if isStaff();
      allow write: if false; // Only Cloud Functions
    }

    // ========================================
    // ğŸ—“ï¸ Monthly Schedules - ì›”ê°„ ìŠ¤ì¼€ì¤„ ë©”íƒ€ë°ì´í„°
    // Staff read, Admin write
    // ========================================
    match /monthly_schedules/{scheduleId} {
      allow read: if isStaff();
      allow write: if isAdmin();
    }

    // ========================================
    // ğŸ“‹ Weekly Templates - ì£¼ê°„ ìŠ¤ì¼€ì¤„ í…œí”Œë¦¿
    // Staff read, Admin write
    // ========================================
    match /weekly_templates/{templateId} {
      allow read: if isStaff();
      allow write: if isAdmin();
    }
    // ========================================
    // âš™ï¸ Settings - í™˜ê²½ ì„¤ì • (ê°•ì‚¬ ëª©ë¡, ìˆ˜ì—… ì¢…ë¥˜ ë“±)
    // Public/Auth read, Admin write
    // ========================================
    match /settings/{settingId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    // ========================================
    // ğŸ§˜ Member Diligence - ì„±ì‹¤ë„ ì ìˆ˜
    // Staff read, System write (via function)
    // ========================================
    match /member_diligence/{memberId} {
      allow read: if isStaff();
      allow write: if false; // Only Cloud Functions
    }

    // ========================================
    // ğŸ› Client Error Logs
    // Anyone can create (for logging), Admin read
    // ========================================
    match /error_logs/{logId} {
      allow read: if isAdmin();
      allow create: if isAuth(); // Require authentication to prevent DoS
      allow update, delete: if isAdmin();
    }

    // ========================================
    // ğŸ“¢ Push History & Approvals
    // Admin only
    // ========================================
    match /push_history/{historyId} {
      allow read, write: if isAdmin();
    }
    
    match /message_approvals/{approvalId} {
      allow read, write: if isAdmin();
    }

    // ========================================
    // ğŸ›¡ï¸ System & Backend Collections
    // Admin read, System write (via Admin SDK)
    // ========================================
    match /rate_limits/{docId} { allow read: if isAdmin(); }
    match /meditation_ai_logs/{docId} { allow read: if isAdmin(); }
    match /practice_events/{docId} { allow read: if isAdmin(); }
    match /ai_quota/{docId} { allow read: if isAdmin(); }
    match /pending_approvals/{docId} { allow read, write: if isAdmin(); }
  }
}
